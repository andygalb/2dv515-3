spanning tree protocol internet protocol suite application layer bgp dhcp dns ftp http https imap ldap mgcp mqtt nntp ntp pop oncrpc rtp rtsp rip sip smtp snmp ssh telnet tlsssl xmpp more transport layer tcp udp dccp sctp rsvp more internet layer ip ipv4 ipv6 icmp icmpv6 ecn igmp ipsec more link layer arp ndp ospf tunnels l2tp ppp mac ethernet dsl isdn fddi more vte the spanning tree protocol stp is a network protocol that builds a loopfree logical topology for ethernet networks the basic function of stp is to prevent bridge loops and the broadcast radiation that results from them spanning tree also allows a network design to include backup links to provide fault tolerance if an active link fails as the name suggests stp creates a spanning tree within a network of connected layer2 bridges and disables those links that are not part of the spanning tree leaving a single active path between any two network nodes stp is based on an algorithm that was invented by radia perlman while she was working for digital equipment corporation in 2001 the ieee introduced rapid spanning tree protocol rstp as 8021w rstp provides significantly faster recovery in response to network changes or failures introducing new convergence behaviors and bridge port roles to do this rstp was designed to be backwardscompatible with standard stp stp was originally standardized as ieee 8021d but the functionality of spanning tree 8021d rapid spanning tree 8021w and multiple spanning tree 8021s has since been incorporated into ieee 8021q2014 protocol operation switches with spanning tree protocol implementation in a local area network lan one switch is the stp root bridge all switch ports that connect a link between two switches are either a root port rp a designated port dp or a blocked port bp the need for the spanning tree protocol stp arose because switches in local area networks lans were often interconnected using redundant links to improve resilience should one connection fail however this connection configuration creates switching loop resulting in broadcast radiations and forwarding information base instability if redundant links are used to connect switches then switching loops need to be avoided potentially an ethernet frame with a destination mac address that is not in the mac address table of the immediate switch can be bounced around between switches in the local area network redundant links between these switches could result in the ethernet frame never reaching a switch that has the destination mac address in its mac address table in such cases switches also broadcast the ethernet frames to all ports except the one from which it entered this can create a broadcast storm however if only one link between switches exists entire segments of the local area network would become unavailable should this one link fail thus it has become best practice to establish a second redundant link between critical switches to avoid the problems associated with redundant links in a switched lan the spanning tree protocol stp is implemented on switches to monitor the network topology every link between switches and in particular redundant links are catalogued stp then disables redundant links by setting up one preferred and optimized link between switches in the lan this preferred link is used for all ethernet frames unless it fails in which case the nonpreferred redundant link is enabled when implemented in a network stp designates one layer 2 switch as root bridge on this root bridge the preferred and nonpreferred links are calculated the root bridge switch constantly communicates with the other switches in the lan that implement stp called nonroot bridges using bridge protocol data units bpdus data rate stp cost rstp cost154 link bandwidth 8021d1998 8021w2004 default value 4mbits 250 5000000 10mbits 100 2000000 16mbits 62 1250000 100mbits 19 200000 1gbits 4 20000 2gbits 3 10000 10gbits 2 2000 100gbits na 200 1tbits na 20 after link failure the spanning tree algorithm computes and spans new leastcost tree provided there is more than one link between two switches the stp root bridge calculates the cost of each path based on bandwidth stp will select the path with the lowest cost that is the highest bandwidth as the preferred link stp will enable this preferred link as the only path to be used for ethernet frames between the two switches and disable all other possible links by designating the switch ports that connect the preferred path as root port154 after stp enabled switches in a lan have elected the root bridge all nonroot bridges assign one of their ports as root port this is either the port that connects the switch to the root bridge or if there are several paths the port with the preferred path as calculated by the root bridge because not all switches are directly connected to the root bridge they communicate amongst each other using stp bridge protocol data units bpdus each switch adds the cost of its own path to the cost received from the neighboring switches to determine the total cost of a given path to the root bridge once the cost of all possible paths to the root bridge have been added up each switch assigns a port as root port which connects to the path with the lowest cost or highest bandwidth that will eventually lead to the root bridge stp switch port states all switch ports in the lan where stp is enabled are categorized blocking a port that would cause a switching loop if it were active no user data is sent or received over a blocking port but it may go into forwarding mode if the other links in use fail and the spanning tree algorithm determines the port may transition to the forwarding state bpdu data is still received in blocking state prevents the use of looped paths listening the switch processes bpdus and awaits possible new information that would cause it to return to the blocking state it does not populate the mac address table and it does not forward frames learning while the port does not yet forward frames it does learn source addresses from frames received and adds them to the filtering database switching database it populates the mac address table but does not forward frames forwarding a port receiving and sending data in ethernet frames normal operation the forwarding port monitors incoming bpdus that would indicate it should return to the blocking state to prevent a loop disabled a network administrator has manually disabled a switch port when a device is first attached to a switch port it will not immediately start to forward data it will instead go through a number of states while it processes bpdus and determines the topology of the network when a host is attached such as a computer printer or server the port always goes into the forwarding state albeit after a delay of about 30 seconds while it goes through the listening and learning states see below the time spent in the listening and learning states is determined by a value known as the forward delay default 15 seconds and set by the root bridge however if instead another switch is connected the port may remain in blocking mode if it is determined that it would cause a loop in the network topology change notification tcn bpdus are used to inform other switches of port changes tcns are injected into the network by a nonroot switch and propagated to the root upon receipt of the tcn the root switch will set a topology change flag in its normal bpdus this flag is propagated to all other switches to instruct them to rapidly age out their forwarding table entries configuring a spanning tree configuring stp and rstp on switches in a lan follows the same principles stp must be enabled on all switches in the lan and the version of stp must be chosen all switches must use the same version of stp then the administrator must determine which switch will be the root bridge and the priority of the other switches in the spanning tree if the root bridge goes down the protocol will automatically assign a new root bridge based on the bridge id if all switches have the same bridge id such as the default id and the root bridge goes down a tie situation arises and the protocol will assign one switch as root bridge based on the switch mac addresses once the switches have been assigned a bridge id and the protocol has chosen the root bridge switch the best path to the root bridge is calculated based on port cost path cost and port priority select a root bridge and the bridge id an example network the numbered boxes represent bridges that is switches in a lan the number is the bridge id the lettered clouds represent network segments the smallest bridge id is 3 therefore bridge 3 is the root bridge the root bridge of the spanning tree is the bridge with the smallest lowest bridge id each bridge has a configurable priority number and a mac address the bridge id is the concatenation of the bridge priority and the mac address for example the id of a bridge with priority 32768 and mac 020000001111 is 32768020000001111 the bridge priority default is 32768 and can only be configured in multiples of 4096 protocol choice of the path to the root bridge the sequence of events to determine the best received bpdu which is the best path to the root is lowest root bridge id determines the root bridge lowest cost to the root bridge favors the upstream switch with the least cost to root lowest sender bridge id serves as a tie breaker if multiple upstream switches have equal cost to root lowest sender port id serves as a tie breaker if a switch has multiple nonetherchannel links to a single upstream switch where bridge id priority 4 bits locally assigned system id extension 12 bits id 48 bits the default bridge priority is 32768 and port id priority 4 bits id interface number 12 bits the default port priority is 128 breaking ties in selecting the path to the root bridge breaking ties for root ports when multiple paths from a bridge are leastcost paths the chosen path uses the neighbor bridge with the lower bridge id the root port is thus the one connecting to the bridge with the lowest bridge id for example in figure 3 if switch 4 were connected to network segment d instead of segment f there would be two paths of length 2 to the root one path going through bridge 24 and the other through bridge 92 because there are two least cost paths the lower bridge id 24 would be used as the tiebreaker in choosing which path to use breaking ties for designated ports when the root bridge has more than one port on a single lan segment the bridge id is effectively tied as are all root path costs all equal zero the designated port then becomes the port on that lan segment with the lowest port id its put into forwarding mode while all other ports on the root bridge on that same lan segment become nondesignated ports and are put into blocking mode not all bridgeswitch manufacturers follow this rule instead making all root bridge ports designated ports and putting them all in forwarding mode a final tiebreaker is required as noted in the section the final tiebreaker path tie the least cost path to the root from network segment e goes through bridge 92 therefore the designated port for network segment e is the port that connects bridge 92 to network segment e when more than one bridge on a segment leads to a leastcost path to the root the bridge with the lower bridge id is used to forward messages to the root the port attaching that bridge to the network segment is the designated port for the segment in the diagram on the right there are two least cost paths from network segment d to the root one going through bridge 24 and the other through bridge 92 the lower bridge id is 24 so the tie breaker dictates that the designated port is the port through which network segment d is connected to bridge 24 if bridge ids were equal then the bridge with the lowest mac address would have the designated port in either case the loser sets the port as being blocked the final tiebreaker in some cases there may still be a tie as when the root bridge has multiple active ports on the same lan segment see above breaking ties for designated ports with equally low root path costs and bridge ids or in other cases multiple bridges are connected by multiple cables and multiple ports in each case a single bridge may have multiple candidates for its root port in these cases candidates for the root port have already received bpdus offering equallylow ie the best root path costs and equallylow ie the best bridge ids and the final tie breaker goes to the port that received the lowest ie the best port priority id or port id bridge protocol data units bridge protocol data unit the above rules describe one way of determining what spanning tree will be computed by the algorithm but the rules as written require knowledge of the entire network the bridges have to determine the root bridge and compute the port roles root designated or blocked with only the information that they have to ensure that each bridge has enough information the bridges use special data frames called bridge protocol data units bpdus to exchange information about bridge ids and root path costs a bridge sends a bpdu frame using the unique mac address of the port itself as a source address and a destination address of the stp multicast address 0180c2000000 there are two types of bpdus in the original stp specification63 the rapid spanning tree rstp extension uses a specific rstp bpdu configuration bpdu cbpdu used for spanning tree computation topology change notification tcn bpdu used to announce changes in the network topology bpdus are exchanged regularly every 2 seconds by default and enable switches to keep track of network changes and to start and stop forwarding at ports as required to prevent the delay when connecting hosts to a switch and during some topology changes rapid stp was developed which allows a switch port to rapidly transition into the forwarding state during these situations bridge protocol data unit fields ieee 8021d and ieee 8021aq bpdus have the following format 1 protocol id 2 bytes 0x0000 ieee 8021d 2 version id 1 byte 0x00 config tcn 0x02 rst 0x03 mst 0x04 spt bpdu 3 bpdu type 1 byte 0x00 stp config bpdu 0x80 tcn bpdu 0x02 rstmst config bpdu 4 flags 1 byte bits usage 1 0 or 1 for topology change 2 0 unused or 1 for proposal in rstmstspt bpdu 34 00 unused or 01 for port role alternatebackup in rstmstspt bpdu 10 for port role root in rstmstspt bpdu 11 for port role designated in rstmstspt bpdu 5 0 unused or 1 for learning in rstmstspt bpdu 6 0 unused or 1 for forwarding in rstmstspt bpdu 7 0 unused or 1 for agreement in rstmstspt bpdu 8 0 or 1 for topology change acknowledgement 5 root id 8 bytes cist root id in mstspt bpdu bits usage 14 root bridge priority 516 root bridge system id extension 1764 root bridge mac address 6 root path cost 4 bytes cist external path cost in mstspt bpdu 7 bridge id 8 bytes cist regional root id in mstspt bpdu bits usage 14 bridge priority 516 bridge system id extension 1764 bridge mac address 8 port id 2 bytes 9 message age 2 bytes in 1256 secs 10 max age 2 bytes in 1256 secs 11 hello time 2 bytes in 1256 secs 12 forward delay 2 bytes in 1256 secs 13 version 1 length 1 byte 0x00 no ver 1 protocol info present rst mst spt bpdu only 14 version 3 length 2 bytes mst spt bpdu only the tcn bpdu includes fields 13 only spanning tree protocol standards the first spanning tree protocol was invented in 1985 at the digital equipment corporation by radia perlman different implementations of a standard are not guaranteed to work due for example to differences in default timer settings the ieee encourages vendors to provide a protocol implementation conformance statement declaring which capabilities and options have been implemented to help users determine whether different implementations will interwork correctly rapid spanning tree protocol in 2001 the ieee introduced rapid spanning tree protocol rstp as 8021w rstp provides significantly faster spanning tree convergence after a topology change introducing new convergence behaviors and bridge port roles to do this rstp was designed to be backwardscompatible with standard stp while stp can take 30 to 50 seconds to respond to a topology change rstp is typically able to respond to changes within 3hello times default 3 times 2 seconds or within a few milliseconds of a physical link failure the hello time is an important and configurable time interval that is used by rstp for several purposes its default value is 2 seconds standard ieee 8021d2004 incorporates rstp and obsoletes the original stp standard rapid spanning tree operation rstp adds new bridge port roles in order to speed convergence following a link failure the number of states a port can be in has been reduced to three instead of stps original five rstp bridge port roles root a forwarding port that is the best port from nonroot bridge to root bridge designated a forwarding port for every lan segment alternate an alternate path to the root bridge this path is different from using the root port backup a backupredundant path to a segment where another bridge port already connects disabled not strictly part of stp a network administrator can manually disable a port rstp switch port states discarding no user data is sent over the port learning the port is not forwarding frames yet but is populating its macaddresstable forwarding the port is fully operational rstp operational details detection of root switch failure is done in 3 hello times which is 6 seconds if the default hello times have not been changed ports may be configured as edge ports if they are attached to a lan that has no other bridges attached these edge ports transition directly to the forwarding state rstp still continues to monitor the port for bpdus in case a bridge is connected rstp can also be configured to automatically detect edge ports as soon as the bridge detects a bpdu coming to an edge port the port becomes a nonedge port rstp calls the connection between two or more switches as a linktype connection a port that operates in fullduplex mode is assumed to be pointtopoint link whereas a halfduplex port through a hub is considered a shared port by default this automatic link type setting can be overridden by explicit configuration rstp improves convergence on pointtopoint links by reducing the maxage time to 3 times hello interval removing the stp listening state and exchanging a handshake between two switches to quickly transition the port to forwarding state rstp does not do anything differently from stp on shared links unlike in stp rstp will respond to bpdus sent from the direction of the root bridge an rstp bridge will propose its spanning tree information to its designated ports if another rstp bridge receives this information and determines this is the superior root information it sets all its other ports to discarding the bridge may send an agreement to the first bridge confirming its superior spanning tree information the first bridge upon receiving this agreement knows it can rapidly transition that port to the forwarding state bypassing the traditional listeninglearning state transition this essentially creates a cascading effect away from the root bridge where each designated bridge proposes to its neighbors to determine if it can make a rapid transition this is one of the major elements that allows rstp to achieve faster convergence times than stp as discussed in the port role details above rstp maintains backup details regarding the discarding status of ports this avoids timeouts if the current forwarding ports were to fail or bpdus were not received on the root port in a certain interval rstp will revert to legacy stp on an interface if a legacy version of an stp bpdu is detected on that port spanning tree protocol standards for vlans stp and rstp do not segregate switch ports by vlan however in ethernet switched environments where multiple virtual lans vlans exist it is often desirable to create multiple spanning trees so that traffic from different vlans uses different links proprietary spanning tree vlan standards before the ieee published a spanning tree protocol standard for vlans a number of vendors who sold vlan capable switches developed their own spanning tree protocol versions that were vlan capable cisco developed implemented and published the pervlan spanning tree pvst proprietary protocol using its own proprietary interswitch link isl for vlan encapsulation and pvst which uses 8021q vlan encapsulation both standards implement a separate spanning tree for every vlan cisco switches now commonly implement pvst and can only implement spanning trees for vlans if the other switches in the lan implement the same vlan stp protocol very few switches from other vendors support ciscos various proprietary protocols hp provides pvst and pvst compatibility in some of its network switches the switch vendor juniper networks in turn developed and implemented its vlan spanning tree protocol vstp to provide compatibility with ciscos pvst so that the switches from both vendors can be included in one lan the vstp protocol is only supported by the ex and mx series from juniper networks there are two restrictions to the compatibility of vstp vstp supports only 253 different spanningtree topologies if there are more than 253 vlans it is recommended to configure rstp in addition to vstp and vlans beyond 253 will be handled by rstp mvrp does not support vstp if this protocol is in use vlan membership for trunk interfaces must be statically configured by default vstp uses the rstp protocol as its core spanningtree protocol but usage of stp can be forced if the network includes old bridges more information about configuring vstp on juniper networks switches was published in the official documentation understanding vstp cisco also published a proprietary version of rapid spanning tree protocol it creates a spanning tree for each vlan just like pvst cisco refers to this as rapid pervlan spanning tree rpvst multiple spanning tree protocol multiple spanning tree protocol the multiple spanning tree protocol mstp originally defined in ieee 8021s and later merged into ieee 8021q2005 defines an extension to rstp to further develop the usefulness of virtual lans vlans in the standard a spanning tree that maps one or more vlans is called multiple spanning tree mst if mstp is implemented a spanning tree can be defined for individual vlans or for groups of vlans furthermore the administrator can define alternate paths within a spanning tree vlans must be assigned to a socalled multiple spanning tree instance msti switches are first assigned to an mst region then vlans are mapped against or assigned to this mst a common spanning tree cst is an mst to which several vlans are mapped this group of vlans is called mst instance msti csts are backward compatible with the stp and rstp standard a mst that has only one vlan assigned to it is a internal spanning tree ist unlike some proprietary pervlan spanning tree implementations mstp includes all of its spanning tree information in a single bpdu format not only does this reduce the number of bpdus required on a lan to communicate spanning tree information for each vlan but it also ensures backward compatibility with rstp and in effect classic stp too mstp does this by encoding additional region information after the standard rstp bpdu as well as a number of msti messages from 0 to 64 instances although in practice many bridges support fewer each of these msti configuration messages conveys the spanning tree information for each instance each instance can be assigned a number of configured vlans and frames packets assigned to these vlans operate in this spanning tree instance whenever they are inside the mst region in order to avoid conveying their entire vlan to spanning tree mapping in each bpdu bridges encode an md5 digest of their vlan to instance table in the mstp bpdu this digest is then used by other mstp bridges along with other administratively configured values to determine if the neighboring bridge is in the same mst region as itself mstp is fully compatible with rstp bridges in that an mstp bpdu can be interpreted by an rstp bridge as an rstp bpdu this not only allows compatibility with rstp bridges without configuration changes but also causes any rstp bridges outside of an mstp region to see the region as a single rstp bridge regardless of the number of mstp bridges inside the region itself in order to further facilitate this view of an mst region as a single rstp bridge the mstp protocol uses a variable known as remaining hops as a time to live counter instead of the message age timer used by rstp the message age time is only incremented once when spanning tree information enters an mst region and therefore rstp bridges will see a region as only one hop in the spanning tree ports at the edge of an mst region connected to either an rstp or stp bridge or an endpoint are known as boundary ports as in rstp these ports can be configured as edge ports to facilitate rapid changes to the forwarding state when connected to endpoints shortest path bridging spb shortest path bridging the ieee approved the ieee 8021aq standard may 2012 spb consolidates multiple existing functionalities including spanning tree protocol stp multiple spanning tree protocol mstp rapid spanning tree protocol rstp link aggregation and multiple mac registration protocol mmrp into a one link state protocol system id extension the bridge id or bid is a field inside a bpdu packet it is eight bytes in length the first two bytes are the bridge priority an unsigned integer of 065535 the last six bytes are a mac address supplied by the bridge prior to ieee 8021d2004 the first two bytes gave a 16 bit bridge priority since ieee 8021d2004 the first four bits are a configurable priority and the last twelve bits carry the bridge system id extension in the case of mst the bridge system id extension carries the mstp instance number some vendors set the bridge system id extension to carry a vlan id allowing a different spanning tree per vlan such as ciscos pvst disadvantages and current practice spanning tree is an older protocol with a longer default holddown time that governs convergence of the protocol state improper use or implementation can contribute to network disruptions the idea of blocking links is something that customers these days do not accept as a proper high availability solution despite being designed primarily as a guard protocol to manage network topology loops spanning tree protocol was often misused as a highavailability method in modern network design it is usually the lack of understanding network media and device operation that result in topology loops whether physical or logical modern networks can make use of all connected links by use of protocols that inhibit control or suppress the natural behavior of logical or physical topology loops switch virtualization techniques like hpe irf aruba vsf and cisco vss combine multiple switches into a single logical entity a multi chassis link aggregation works like a normal lacp trunk only distributed through multiple switches conversely partitioning technologies compartmentalize a single physical chassis into multiple logical entities on the edge of the network loopdetection is configured to prevent accidental loops by users bridge protocol data unit distributed minimum spanning tree etherchannel ethernet automatic protection switching flex links flooding computer networking media redundancy protocol minimum spanning tree trill transparent interconnection of lots of links unidirectional link detection virtual link trunking notes wikimedia commons has media related to spanning tree protocol cisco home page for the spanningtree protocol family discusses cst mistp pvst pvst rstp stp educational explanation of stp archived from the original on 20160304 stp article in the wireshark wiki includes a sample pcapfile of captured stp traffic perlman radia algorhyme university of california at berkeley archived from the original on 20110719 retrieved 20110901 ieee standards ansiieee 8021d2004 standard section 17 discusses rstp regular stp is no longer a part of this standard this is pointed out in section 8 ansiieee 8021q2005 standard section 13 discusses mstp rfcs rfc 26741999 proposed standard definitions of managed objects for bridges with traffic classes multicast filtering and virtual lan extensions rfc 15251993 sbridgemib proposed standard definitions of managed objects for source routing bridges rfc 14931993 bridgemib draft standard definitions of managed objects for bridges spanning tree direct vs indirect link failures ccie study spanning tree protocol overview vteieee standardscurrent 488 730 754 revision 854 828 829 896 1003 1014 1016 1076 11491 1154 1164 1275 1278 1284 1355 1394 1451 1497 1516 1541 1547 1584 1588 1596 1603 1613 1666 1667 1675 1685 1722 1733 1800 1801 1815 1850 1900 1901 1902 1904 1905 2030 11073 12207 14764 16085 16326 29148 42010 802 series8021 d p q qat qay w x ab ad ae ag ah ak aq as ax az ba 80211 a b c d e f g h i j k n p r s u v w y ac ad af ah ai ax ay 2 3 4 5 6 7 8 9 10 12 14 15 1 4 4a 16 d e 17 18 20 21 22proposed p1363 p1619 p1699 p1823 p19061 superseded 7541985 830 1219 1233 1362 1364 1471 see also ieee standards association categoryieee standards 